---
title: "linux file storage_inode"
date: 2021-08-17T13:48:22+08:00
draft: false
author: LYR
---

# 文件存储结构

大部分的Linux文件系统（如ext2、ext3）规定，一个文件由目录项、inode和数据块组成

- 目录项：包括文件名和inode节点号。
- Inode：又称文件索引节点，包含文件的基础信息以及数据块的指针。
- 数据块：包含文件的具体内容。



```bash

stat test.sh
:<<EOF
文件：test.sh
  大小：90              块：8          IO 块：4096   普通文件
设备：810h/2064d        Inode：3620        硬链接：1
权限：(0764/-rwxrw-r--)  Uid：( 1000/     lyr)   Gid：( 1000/     lyr)
最近访问：2021-09-21 23:25:30.164995900 +0800
最近更改：2021-09-21 23:25:25.564995900 +0800
最近改动：2021-09-21 23:25:25.684995900 +0800
创建时间：-

EOF

```



操作系统读取硬盘的时候，不会一个扇区一个扇区地读取，这样效率太低，而是一次性连续读取多个扇区，即一次性读取一个"块"（block）。这种由多个扇区组成的"块"，是文件存取的最小单位。，即连续八个 sector组成一个 block。

**文件数据都储存在"块"中**，那么很显然，**我们还必须找到一个地方储存文件**的**元信息**，比如文件的创建者、文件的创建日期、文件的大小等等。这种**储存文件元信息的区域就叫做inode**，中文译名为"索引节点"。

inode包含文件的元信息，具体来说有以下内容：

- 文件的字节数。
- 文件拥有者的User ID。
- 文件的Group ID。
- 文件的读、写、执行权限。
- 文件的时间戳，共有三个：ctime指inode上一次变动的时间，mtime指文件内容上一次变动的时间，atime指文件上一次打开的时间。
- 链接数，即有多少文件名指向这个inode。
- 文件数据block的位置。

总之，除了文件名以外的所有文件信息，都存在inode之中。

当查看某个文件时，会先从inode表中查出文件属性及数据存放点，再从数据块中读取数据。

请看文件存储结构示意图：

![img](https://cdn.jsdelivr.net/gh/lyr-2000/images_repo_2021_ASUS/2021_09_22_14_57_15linux-storage.png)

### 1.1. inode的大小

inode也会消耗硬盘空间，所以硬盘格式化的时候，操作系统**自动将硬盘分成两个区域**。一个是**数据区**，存放文件数据；另一个是**inode区（inode table）**，存放inode所包含的信息。

每个inode节点的大小，一般是128字节或256字节。inode节点的总数，在格式化时就给定，一般是每1KB或每2KB就设置一个inode。**假定在一块1GB的硬盘中，每个inode节点的大小为128字节**，每1KB就设置一个inode，那么inode table的大小就会达到128MB，占整块硬盘的12.8%。

查看每个硬盘分区的inode总数和已经使用的数量，可以使用df -i 命令。

查看每个inode节点的大小，可以用如下命令：

```bash
sudo dumpe2fs -h /dev/hda | grep "Inode size"
```



由于**每个文件都必须有一个inode**，因此有可能**发生inode已经用光**，**但是硬盘还未存满的情况**。这时，就无法在硬盘上创建新文件。





###  查看inode 的 id



```bash
ls -i app.sh
# 51738 app.sh
```

## 3. 目录项

Linux系统中，目录（directory）也是一种文件。打开目录，实际上就是打开目录文件。

目录文件的结构非常简单，就是一系列目录项（dirent）的列表。每个目录项，由两部分组成：所包含文件的文件名，以及该文件名对应的inode号码。

ls命令只列出目录文件中的所有文件名：

```bash
ls /etc
```









#  软硬链接





### 4.1. 硬链接

一般情况下，文件名和inode号码是"一一对应"关系，每个inode号码对应一个文件名。但是，Linux系统允许，**多个文件名指向同一个inode号码**。这意味着，可以用不同的文件名访问同样的内容；**对文件内容进行修改，会影响到所有文件名**；但是，**删除一个文件名，不影响另一个文件名的访问**。这种情况就被称为"硬链接"（hard link）。



ln命令可以创建硬链接

```bash
ln source_file target_file
```



这里顺便说一下目录文件的"链接数"。**创建目录时**，默认**会生成两个目录项**："."和".."。**前者的inode号码就是当前目录的inode号码，等同于当前目录的"硬链接"**；**后者的inode号码就是当前目录的父目录的inode号码**，**等同于父目录的"硬链接"**。所以，**任何一个目录的"硬链接"总数**，总是等于2加上它的子目录总数（含隐藏目录）,这里的2是父目录对其的“硬链接”和当前目录下的".硬链接“。





###  软链接



除了硬链接以外，还有一种特殊情况。文件A和文件B的inode号码虽然不一样，但是文件A的内容是文件B的路径。读取文件A时，系统会自动将访问者导向文件B。因此，无论打开哪一个文件，最终读取的都是文件B。这时，文件A就称为文件B的"软链接"（soft link）或者"符号链接（symbolic link）。

这意味着，文件A依赖于文件B而存在，如果删除了文件B，打开文件A就会报错："No such file or directory"。这是软链接与硬链接最大的不同：文件A指向文件B的文件名，而不是文件B的inode号码，文件B的inode"链接数"不会因此发生变化。

ln -s命令可以创建软链接

```bash
ln -s source_file target_file
```

 

相当于快捷方式这样子喽







