---
title: 设计一个抢红包功能
date: 2021-03-30 18:17:15
permalink: /pages/cfc81f/
categories:
  - 其他
  - 业务问题
tags:
  - 
---
这个其实可以使用事务来实现，比如我们可以用MySQL，抢红包时先开启事务，然后加上行锁，修改完毕后我们提交事务，释放行锁

或者我们可以使用Redis，我们获取分布式锁，然后对数据进行操作，流程图如下

![img](https://img.xiaoyou66.com/2021/03/30/21ebe15bfd306.jpg)

- 老板发红包，此时缓存初始化红包个数，红包金额(单位分)，并异步入库。
- 抢红包，判断缓存剩余红包金额，剩余金额大于零则抢到红包，否则手慢了，红包派完了
- 拆红包，根据 `redPacketId` 获取分布式锁，如果获取到锁，红包个数减一，如果剩余红包个数大于零抢红包成功、否则失败。成功则计算红包金额，缓存总红包金额减去抢到的红包金额，异步入库、异步到账。

参考

1. [微信红包的设计考虑 | 鱼儿的博客 (yuerblog.cc)](https://yuerblog.cc/2017/10/27/wechat-red-packet-arch/)
2. [微信高并发抢红包秒杀实战案例 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/105692236)

