<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>redis哨兵集群使用 - 笔试面试经验浓缩</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="LYR" /><meta name="description" content="1. 部署Redis集群 redis的安装及配置参考[redis部署] 本文以创建一主二从的集群为例。 1.1 部署与配置 先创建sentinel目录，在该目" /><meta name="keywords" content="LYR的文档站, LYR的个人博客, even" />






<meta name="generator" content="Hugo 0.74.2 with theme even" />


<link rel="canonical" href="https://lyr-2000.github.io/post/11.%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%93/mysql/%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis-sentinel/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="redis哨兵集群使用" />
<meta property="og:description" content="1. 部署Redis集群 redis的安装及配置参考[redis部署] 本文以创建一主二从的集群为例。 1.1 部署与配置 先创建sentinel目录，在该目" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lyr-2000.github.io/post/11.%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%93/mysql/%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis-sentinel/" />
<meta property="article:published_time" content="2021-08-17T13:48:22+08:00" />
<meta property="article:modified_time" content="2021-08-17T13:48:22+08:00" />
<meta itemprop="name" content="redis哨兵集群使用">
<meta itemprop="description" content="1. 部署Redis集群 redis的安装及配置参考[redis部署] 本文以创建一主二从的集群为例。 1.1 部署与配置 先创建sentinel目录，在该目">
<meta itemprop="datePublished" content="2021-08-17T13:48:22&#43;08:00" />
<meta itemprop="dateModified" content="2021-08-17T13:48:22&#43;08:00" />
<meta itemprop="wordCount" content="4868">



<meta itemprop="keywords" content="redis," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="redis哨兵集群使用"/>
<meta name="twitter:description" content="1. 部署Redis集群 redis的安装及配置参考[redis部署] 本文以创建一主二从的集群为例。 1.1 部署与配置 先创建sentinel目录，在该目"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">LYR的文档站</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><li style="display:inline-block;margin-right:10px;">
			<input type="search" class="mob-docsearch-input" placeholder="Search" />
		</li><a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档页</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a><a href="/friends">
        <li class="mobile-menu-item">大佬</li>
      </a>
	
	
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">LYR的文档站</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/friends">大佬</a>
      </li><li style="menu-item;list-style: none;position: relative;left: 310px;bottom: 26px;">
		<input type="search" class="docsearch-input" placeholder="Search" />
	  </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">redis哨兵集群使用</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-08-17 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1-部署redis集群">1. 部署Redis集群</a>
      <ul>
        <li><a href="#11-部署与配置">1.1 部署与配置</a></li>
        <li><a href="#12-配置主从关系">1.2 配置主从关系</a></li>
      </ul>
    </li>
    <li><a href="#2-部署sentinel集群">2. 部署sentinel集群</a>
      <ul>
        <li><a href="#21-部署与配置">2.1 部署与配置</a></li>
        <li><a href="#22-启动sentinel实例">2.2 启动sentinel实例</a></li>
        <li><a href="#23-查看状态">2.3 查看状态</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="1-部署redis集群">1. 部署Redis集群</h1>
<p>redis的安装及配置参考[redis部署]</p>
<blockquote>
<p>本文以创建一主二从的集群为例。</p>
</blockquote>
<h2 id="11-部署与配置">1.1 部署与配置</h2>
<p>先创建<code>sentinel</code>目录，在该目录下创建<code>8000</code>，<code>8001</code>，<code>8002</code>三个以端口号命名的目录。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mkdir sentinel
<span class="nb">cd</span> sentinel
mkdir <span class="m">8000</span> <span class="m">8001</span> <span class="m">8002</span> 
</code></pre></td></tr></table>
</div>
</div><p>在对应端口号目录中创建<code>redis.conf</code>的文件，配置文件中的端口号<code>port</code>参数改为对应目录的端口号。配置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 守护进程模式</span>
daemonize yes

<span class="c1"># pid file</span>
pidfile /var/run/redis.pid

<span class="c1"># 监听端口</span>
port <span class="m">8000</span>

<span class="c1"># TCP接收队列长度，受/proc/sys/net/core/somaxconn和tcp_max_syn_backlog这两个内核参数的影响</span>
tcp-backlog <span class="m">511</span>

<span class="c1"># 一个客户端空闲多少秒后关闭连接(0代表禁用，永不关闭)</span>
timeout <span class="m">0</span>

<span class="c1"># 如果非零，则设置SO_KEEPALIVE选项来向空闲连接的客户端发送ACK</span>
tcp-keepalive <span class="m">60</span>

<span class="c1"># 指定服务器调试等级</span>
<span class="c1"># 可能值：</span>
<span class="c1"># debug （大量信息，对开发/测试有用）</span>
<span class="c1"># verbose （很多精简的有用信息，但是不像debug等级那么多）</span>
<span class="c1"># notice （适量的信息，基本上是你生产环境中需要的）</span>
<span class="c1"># warning （只有很重要/严重的信息会记录下来）</span>
loglevel notice

<span class="c1"># 指明日志文件名</span>
logfile <span class="s2">&#34;./redis8000.log&#34;</span>

<span class="c1"># 设置数据库个数</span>
databases <span class="m">16</span>

<span class="c1"># 会在指定秒数和数据变化次数之后把数据库写到磁盘上</span>
<span class="c1"># 900秒（15分钟）之后，且至少1次变更</span>
<span class="c1"># 300秒（5分钟）之后，且至少10次变更</span>
<span class="c1"># 60秒之后，且至少10000次变更</span>
save <span class="m">900</span> <span class="m">1</span>
save <span class="m">300</span> <span class="m">10</span>
save <span class="m">60</span> <span class="m">10000</span>


<span class="c1"># 默认如果开启RDB快照(至少一条save指令)并且最新的后台保存失败，Redis将会停止接受写操作</span>
<span class="c1"># 这将使用户知道数据没有正确的持久化到硬盘，否则可能没人注意到并且造成一些灾难</span>
stop-writes-on-bgsave-error yes

<span class="c1"># 当导出到 .rdb 数据库时是否用LZF压缩字符串对象</span>
rdbcompression yes

<span class="c1"># 版本5的RDB有一个CRC64算法的校验和放在了文件的最后。这将使文件格式更加可靠。</span>
rdbchecksum yes

<span class="c1"># 持久化数据库的文件名</span>
dbfilename dump.rdb

<span class="c1"># 工作目录</span>
dir ./

<span class="c1"># 当master服务设置了密码保护时，slave服务连接master的密码</span>
masterauth 0234kz9*l

<span class="c1"># 当一个slave失去和master的连接，或者同步正在进行中，slave的行为可以有两种：</span>
#
<span class="c1"># 1) 如果 slave-serve-stale-data 设置为 &#34;yes&#34; (默认值)，slave会继续响应客户端请求，</span>
<span class="c1"># 可能是正常数据，或者是过时了的数据，也可能是还没获得值的空数据。</span>
<span class="c1"># 2) 如果 slave-serve-stale-data 设置为 &#34;no&#34;，slave会回复&#34;正在从master同步</span>
<span class="c1"># （SYNC with master in progress）&#34;来处理各种请求，除了 INFO 和 SLAVEOF 命令。</span>
slave-serve-stale-data yes

<span class="c1"># 你可以配置salve实例是否接受写操作。可写的slave实例可能对存储临时数据比较有用(因为写入salve</span>
<span class="c1"># 的数据在同master同步之后将很容易被删除</span>
slave-read-only yes

<span class="c1"># 是否在slave套接字发送SYNC之后禁用 TCP_NODELAY？</span>
<span class="c1"># 如果你选择“yes”Redis将使用更少的TCP包和带宽来向slaves发送数据。但是这将使数据传输到slave</span>
<span class="c1"># 上有延迟，Linux内核的默认配置会达到40毫秒</span>
<span class="c1"># 如果你选择了 &#34;no&#34; 数据传输到salve的延迟将会减少但要使用更多的带宽</span>
repl-disable-tcp-nodelay no

<span class="c1"># slave的优先级是一个整数展示在Redis的Info输出中。如果master不再正常工作了，哨兵将用它来</span>
<span class="c1"># 选择一个slave提升=升为master。</span>
<span class="c1"># 优先级数字小的salve会优先考虑提升为master，所以例如有三个slave优先级分别为10，100，25，</span>
<span class="c1"># 哨兵将挑选优先级最小数字为10的slave。</span>
<span class="c1"># 0作为一个特殊的优先级，标识这个slave不能作为master，所以一个优先级为0的slave永远不会被</span>
<span class="c1"># 哨兵挑选提升为master</span>
slave-priority <span class="m">100</span>


<span class="c1"># 密码验证</span>
<span class="c1"># 警告：因为Redis太快了，所以外面的人可以尝试每秒150k的密码来试图破解密码。这意味着你需要</span>
<span class="c1"># 一个高强度的密码，否则破解太容易了</span>
requirepass 0234kz9*l

<span class="c1"># redis实例最大占用内存，不要用比设置的上限更多的内存。一旦内存使用达到上限，Redis会根据选定的回收策略（参见：</span>
<span class="c1"># maxmemmory-policy）删除key</span>
maxmemory 3gb

<span class="c1"># 最大内存策略：如果达到内存限制了，Redis如何选择删除key。你可以在下面五个行为里选：</span>
<span class="c1"># volatile-lru -&gt; 根据LRU算法删除带有过期时间的key。</span>
<span class="c1"># allkeys-lru -&gt; 根据LRU算法删除任何key。</span>
<span class="c1"># volatile-random -&gt; 根据过期设置来随机删除key, 具备过期时间的key。</span>
<span class="c1"># allkeys-&gt;random -&gt; 无差别随机删, 任何一个key。</span>
<span class="c1"># volatile-ttl -&gt; 根据最近过期时间来删除（辅以TTL）, 这是对于有过期时间的key</span>
<span class="c1"># noeviction -&gt; 谁也不删，直接在写操作时返回错误。</span>
maxmemory-policy volatile-lru

<span class="c1"># 默认情况下，Redis是异步的把数据导出到磁盘上。这种模式在很多应用里已经足够好，但Redis进程</span>
<span class="c1"># 出问题或断电时可能造成一段时间的写操作丢失(这取决于配置的save指令)。</span>
#
<span class="c1"># AOF是一种提供了更可靠的替代持久化模式，例如使用默认的数据写入文件策略（参见后面的配置）</span>
<span class="c1"># 在遇到像服务器断电或单写情况下Redis自身进程出问题但操作系统仍正常运行等突发事件时，Redis</span>
<span class="c1"># 能只丢失1秒的写操作。</span>
#
<span class="c1"># AOF和RDB持久化能同时启动并且不会有问题。</span>
<span class="c1"># 如果AOF开启，那么在启动时Redis将加载AOF文件，它更能保证数据的可靠性。</span>
appendonly no

<span class="c1"># aof文件名</span>
appendfilename <span class="s2">&#34;appendonly.aof&#34;</span>

<span class="c1"># fsync() 系统调用告诉操作系统把数据写到磁盘上，而不是等更多的数据进入输出缓冲区。</span>
<span class="c1"># 有些操作系统会真的把数据马上刷到磁盘上；有些则会尽快去尝试这么做。</span>
#
<span class="c1"># Redis支持三种不同的模式：</span>
#
<span class="c1"># no：不要立刻刷，只有在操作系统需要刷的时候再刷。比较快。</span>
<span class="c1"># always：每次写操作都立刻写入到aof文件。慢，但是最安全。</span>
<span class="c1"># everysec：每秒写一次。折中方案。</span>
appendfsync everysec

<span class="c1"># 如果AOF的同步策略设置成 &#34;always&#34; 或者 &#34;everysec&#34;，并且后台的存储进程（后台存储或写入AOF</span>
<span class="c1"># 日志）会产生很多磁盘I/O开销。某些Linux的配置下会使Redis因为 fsync()系统调用而阻塞很久。</span>
<span class="c1"># 注意，目前对这个情况还没有完美修正，甚至不同线程的 fsync() 会阻塞我们同步的write(2)调用。</span>
#
<span class="c1"># 为了缓解这个问题，可以用下面这个选项。它可以在 BGSAVE 或 BGREWRITEAOF 处理时阻止主进程进行fsync()。</span>
#
<span class="c1"># 这就意味着如果有子进程在进行保存操作，那么Redis就处于&#34;不可同步&#34;的状态。</span>
<span class="c1"># 这实际上是说，在最差的情况下可能会丢掉30秒钟的日志数据。（默认Linux设定）</span>
#
<span class="c1"># 如果你有延时问题把这个设置成&#34;yes&#34;，否则就保持&#34;no&#34;，这是保存持久数据的最安全的方式。</span>
no-appendfsync-on-rewrite yes

<span class="c1"># 自动重写AOF文件</span>
auto-aof-rewrite-percentage <span class="m">100</span>
auto-aof-rewrite-min-size 64mb

<span class="c1"># AOF文件可能在尾部是不完整的（这跟system关闭有问题，尤其是mount ext4文件系统时</span>
<span class="c1"># 没有加上data=ordered选项。只会发生在os死时，redis自己死不会不完整）。</span>
<span class="c1"># 那redis重启时load进内存的时候就有问题了。</span>
<span class="c1"># 发生的时候，可以选择redis启动报错，并且通知用户和写日志，或者load尽量多正常的数据。</span>
<span class="c1"># 如果aof-load-truncated是yes，会自动发布一个log给客户端然后load（默认）。</span>
<span class="c1"># 如果是no，用户必须手动redis-check-aof修复AOF文件才可以。</span>
<span class="c1"># 注意，如果在读取的过程中，发现这个aof是损坏的，服务器也是会退出的，</span>
<span class="c1"># 这个选项仅仅用于当服务器尝试读取更多的数据但又找不到相应的数据时。</span>
aof-load-truncated yes

<span class="c1"># Lua 脚本的最大执行时间，毫秒为单位</span>
lua-time-limit <span class="m">5000</span>

<span class="c1"># Redis慢查询日志可以记录超过指定时间的查询</span>
slowlog-log-slower-than <span class="m">10000</span>

<span class="c1"># 这个长度没有限制。只是要主要会消耗内存。你可以通过 SLOWLOG RESET 来回收内存。</span>
slowlog-max-len <span class="m">128</span>

<span class="c1"># redis延时监控系统在运行时会采样一些操作，以便收集可能导致延时的数据根源。</span>
<span class="c1"># 通过 LATENCY命令 可以打印一些图样和获取一些报告，方便监控</span>
<span class="c1"># 这个系统仅仅记录那个执行时间大于或等于预定时间（毫秒）的操作,</span>
<span class="c1"># 这个预定时间是通过latency-monitor-threshold配置来指定的，</span>
<span class="c1"># 当设置为0时，这个监控系统处于停止状态</span>
latency-monitor-threshold <span class="m">0</span>

<span class="c1"># Redis能通知 Pub/Sub 客户端关于键空间发生的事件，默认关闭</span>
notify-keyspace-events <span class="s2">&#34;&#34;</span>

<span class="c1"># 当hash只有少量的entry时，并且最大的entry所占空间没有超过指定的限制时，会用一种节省内存的</span>
<span class="c1"># 数据结构来编码。可以通过下面的指令来设定限制</span>
hash-max-ziplist-entries <span class="m">512</span>
hash-max-ziplist-value <span class="m">64</span>

<span class="c1"># 与hash似，数据元素较少的list，可以用另一种方式来编码从而节省大量空间。</span>
<span class="c1"># 这种特殊的方式只有在符合下面限制时才可以用</span>
list-max-ziplist-entries <span class="m">512</span>
list-max-ziplist-value <span class="m">64</span>

<span class="c1"># set有一种特殊编码的情况：当set数据全是十进制64位有符号整型数字构成的字符串时。</span>
<span class="c1"># 下面这个配置项就是用来设置set使用这种编码来节省内存的最大长度。</span>
set-max-intset-entries <span class="m">512</span>

<span class="c1"># 与hash和list相似，有序集合也可以用一种特别的编码方式来节省大量空间。</span>
<span class="c1"># 这种编码只适合长度和元素都小于下面限制的有序集合</span>
zset-max-ziplist-entries <span class="m">128</span>
zset-max-ziplist-value <span class="m">64</span>

<span class="c1"># HyperLogLog稀疏结构表示字节的限制。该限制包括</span>
<span class="c1"># 16个字节的头。当HyperLogLog使用稀疏结构表示</span>
<span class="c1"># 这些限制，它会被转换成密度表示。</span>
<span class="c1"># 值大于16000是完全没用的，因为在该点</span>
<span class="c1"># 密集的表示是更多的内存效率。</span>
<span class="c1"># 建议值是3000左右，以便具有的内存好处, 减少内存的消耗</span>
hll-sparse-max-bytes <span class="m">3000</span>

<span class="c1"># 启用哈希刷新，每100个CPU毫秒会拿出1个毫秒来刷新Redis的主哈希表（顶级键值映射表）</span>
activerehashing yes

<span class="c1"># 客户端的输出缓冲区的限制，可用于强制断开那些因为某种原因从服务器读取数据的速度不够快的客户端</span>
client-output-buffer-limit normal <span class="m">0</span> <span class="m">0</span> <span class="m">0</span>
client-output-buffer-limit slave 256mb 64mb <span class="m">60</span>
client-output-buffer-limit pubsub 32mb 8mb <span class="m">60</span>

<span class="c1"># 默认情况下，“hz”的被设定为10。提高该值将在Redis空闲时使用更多的CPU时，但同时当有多个key</span>
<span class="c1"># 同时到期会使Redis的反应更灵敏，以及超时可以更精确地处理</span>
hz <span class="m">10</span>

<span class="c1"># 当一个子进程重写AOF文件时，如果启用下面的选项，则文件每生成32M数据会被同步</span>
aof-rewrite-incremental-fsync yes
</code></pre></td></tr></table>
</div>
</div><h2 id="12-配置主从关系">1.2 配置主从关系</h2>
<p><strong>1、启动实例</strong></p>
<p>三个Redis实例配置相同，分别启动三个Redis实例。建议将<code>redis-server</code>、<code>redis-cli</code>、<code>redis-sentinel</code>的二进制复制到<code>/usr/local/bin</code>的目录下。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> <span class="m">8000</span>
redis-server redis.conf
</code></pre></td></tr></table>
</div>
</div><p><strong>2、配置主从关系</strong></p>
<p>例如，将8000端口实例设为主，8001和8002端口的实例设为从。</p>
<p>则分别登录8001和8002的实例，执行<code>slaveof &lt;MASTER_IP&gt; &lt;MASTER_PORT&gt;</code>命令。</p>
<p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>root@kube-node-1 8000<span class="o">]</span><span class="c1"># redis-cli -c -p 8001 -a 0234kz9*l</span>
127.0.0.1:8001&gt; slaveof 127.0.0.1 <span class="m">8000</span>
OK
</code></pre></td></tr></table>
</div>
</div><p><strong>3、检查集群状态</strong></p>
<p>登录master和slave实例，执行<code>info replication</code>查看集群状态。</p>
<p>Master</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>root@kube-node-1 8000<span class="o">]</span><span class="c1"># redis-cli -c -p 8000 -a 0234kz9*l</span>
127.0.0.1:8000&gt; info replication
<span class="c1"># Replication</span>
role:master
connected_slaves:2
slave0:ip<span class="o">=</span>127.0.0.1,port<span class="o">=</span>8001,state<span class="o">=</span>online,offset<span class="o">=</span>2853,lag<span class="o">=</span><span class="m">0</span>
slave1:ip<span class="o">=</span>127.0.0.1,port<span class="o">=</span>8002,state<span class="o">=</span>online,offset<span class="o">=</span>2853,lag<span class="o">=</span><span class="m">0</span>
master_replid:4f8331d5f180a4669241ab0dd97e43508abd6d8f
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:2853
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:2853
</code></pre></td></tr></table>
</div>
</div><p>Slave</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>root@kube-node-1 8000<span class="o">]</span><span class="c1"># redis-cli -c -p 8001 -a 0234kz9*l</span>
127.0.0.1:8001&gt; info replication
<span class="c1"># Replication</span>
role:slave
master_host:127.0.0.1
master_port:8000
master_link_status:up
master_last_io_seconds_ago:3
master_sync_in_progress:0
slave_repl_offset:2909
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:4f8331d5f180a4669241ab0dd97e43508abd6d8f
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:2909
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:2909
</code></pre></td></tr></table>
</div>
</div><p>也可以往master写数据，从slave读取数据来验证。</p>
<h1 id="2-部署sentinel集群">2. 部署sentinel集群</h1>
<h2 id="21-部署与配置">2.1 部署与配置</h2>
<p>在之前创建的<code>sentinel</code>目录中场景sentinel端口号命名的目录<code>28000</code>，<code>28001</code>，<code>28002</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> sentinel
mkdir <span class="m">28000</span> <span class="m">28001</span> <span class="m">28002</span> 
</code></pre></td></tr></table>
</div>
</div><p>在对应端口号目录中创建<code>redis.conf</code>的文件，配置文件中的端口号<code>port</code>参数改为对应目录的端口号。配置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">port <span class="m">28000</span>
sentinel monitor mymaster 127.0.0.1 <span class="m">8000</span> <span class="m">2</span>
sentinel down-after-milliseconds mymaster <span class="m">60000</span>
sentinel failover-timeout mymaster <span class="m">180000</span>
sentinel parallel-syncs mymaster <span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="22-启动sentinel实例">2.2 启动sentinel实例</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">#&amp; 表示后台运行的方式</span>
redis-sentinel sentinel.conf <span class="p">&amp;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="23-查看状态">2.3 查看状态</h2>
<p>使用<code>sentinel masters</code>命令查看监控的master节点。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>root@kube-node-1 28000<span class="o">]</span><span class="c1"># redis-cli -c -p 28000 -a 0234kz9*l</span>
127.0.0.1:28000&gt;
127.0.0.1:28000&gt; ping
PONG
127.0.0.1:28000&gt;
127.0.0.1:28000&gt; sentinel masters
1<span class="o">)</span>  1<span class="o">)</span> <span class="s2">&#34;name&#34;</span>
    1<span class="o">)</span> <span class="s2">&#34;mymaster&#34;</span>
    2<span class="o">)</span> <span class="s2">&#34;ip&#34;</span>
    3<span class="o">)</span> <span class="s2">&#34;127.0.0.1&#34;</span>
    4<span class="o">)</span> <span class="s2">&#34;port&#34;</span>
    5<span class="o">)</span> <span class="s2">&#34;8000&#34;</span>
    6<span class="o">)</span> <span class="s2">&#34;runid&#34;</span>
    7<span class="o">)</span> <span class="s2">&#34;&#34;</span>
    8<span class="o">)</span> <span class="s2">&#34;flags&#34;</span>
   1<span class="o">)</span>  <span class="s2">&#34;s_down,master,disconnected&#34;</span>
   2<span class="o">)</span>  <span class="s2">&#34;link-pending-commands&#34;</span>
   3<span class="o">)</span>  <span class="s2">&#34;0&#34;</span>
   4<span class="o">)</span>  <span class="s2">&#34;link-refcount&#34;</span>
   5<span class="o">)</span>  <span class="s2">&#34;1&#34;</span>
   6<span class="o">)</span>  <span class="s2">&#34;last-ping-sent&#34;</span>
   7<span class="o">)</span>  <span class="s2">&#34;187539&#34;</span>
   8<span class="o">)</span>  <span class="s2">&#34;last-ok-ping-reply&#34;</span>
   9<span class="o">)</span>  <span class="s2">&#34;187539&#34;</span>
   10<span class="o">)</span> <span class="s2">&#34;last-ping-reply&#34;</span>
   11<span class="o">)</span> <span class="s2">&#34;3943&#34;</span>
   12<span class="o">)</span> <span class="s2">&#34;s-down-time&#34;</span>
   13<span class="o">)</span> <span class="s2">&#34;127491&#34;</span>
   14<span class="o">)</span> <span class="s2">&#34;down-after-milliseconds&#34;</span>
   15<span class="o">)</span> <span class="s2">&#34;60000&#34;</span>
   16<span class="o">)</span> <span class="s2">&#34;info-refresh&#34;</span>
   17<span class="o">)</span> <span class="s2">&#34;1517346914642&#34;</span>
   18<span class="o">)</span> <span class="s2">&#34;role-reported&#34;</span>
   19<span class="o">)</span> <span class="s2">&#34;master&#34;</span>
   20<span class="o">)</span> <span class="s2">&#34;role-reported-time&#34;</span>
   21<span class="o">)</span> <span class="s2">&#34;187539&#34;</span>
   22<span class="o">)</span> <span class="s2">&#34;config-epoch&#34;</span>
   23<span class="o">)</span> <span class="s2">&#34;0&#34;</span>
   24<span class="o">)</span> <span class="s2">&#34;num-slaves&#34;</span>
   25<span class="o">)</span> <span class="s2">&#34;0&#34;</span>
   26<span class="o">)</span> <span class="s2">&#34;num-other-sentinels&#34;</span>
   27<span class="o">)</span> <span class="s2">&#34;0&#34;</span>
   28<span class="o">)</span> <span class="s2">&#34;quorum&#34;</span>
   29<span class="o">)</span> <span class="s2">&#34;2&#34;</span>
   30<span class="o">)</span> <span class="s2">&#34;failover-timeout&#34;</span>
   31<span class="o">)</span> <span class="s2">&#34;180000&#34;</span>
   32<span class="o">)</span> <span class="s2">&#34;parallel-syncs&#34;</span>
   33<span class="o">)</span> <span class="s2">&#34;1&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>参考文章：</p>
<p><a href="https://redis.io/topics/sentinel">https://redis.io/topics/sentinel</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">LYR</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-08-17
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/redis/">redis</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/11.%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%93/mysql/%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis-introduction/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">redis介绍</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/11.%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%93/mysql/%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis-cluster/">
            <span class="next-text nav-default">redis部署过程</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:lyr-2000@qq.com" class="iconfont icon-email" title="email"></a>
  <a href="" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>lyr</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>






<script src="/js//custom/latex_plugin.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
docsearch({
    apiKey: "2991187e127fb95e62db841ea946bc06",
    indexName: "blog",
    appId: "UVGAU2QDTQ",
    inputSelector: '.docsearch-input',
    debug: false,
});
docsearch({
    apiKey: "2991187e127fb95e62db841ea946bc06",
    indexName: "blog",
    appId: "UVGAU2QDTQ",
    inputSelector: '.mob-docsearch-input',
    debug: false,
});
</script>
</body>
</html>
