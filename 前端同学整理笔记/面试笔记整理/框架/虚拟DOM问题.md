在一般的DOM更新中，每当我们更新一个DOM节点，就需要进行浏览器的所有渲染工作，而虚拟DOM的使用，可以通过使用js对象，在js对象上计算多次DOM节点的更新，然后一次性地渲染到页面上。

使用js模拟DOM节点实现虚拟DOM
```javascript
const tree = Element('div',{id:'Virtual-container'},[
    Element('h1',{},['Virtual title']),
    Element('ul',{},[
        Element('li',{},['item 1']),
        Element('li',{},['item 2']),
        Element('li',{},['item 3'])
    ])
])
```
这个虚拟DOM就对应于下面的这个DOM节点
```html
<div id="Virtual-container">
    <h1>Virtual title</h1>
    <ul>
        <li>item 1</li>
        <li>item 2</li>
        <li>item 3</li>
    </ul>
</div>
```
实际上，在进行一系列修改DOM的操作时，我们会有新旧两个虚拟DOM，通过diff算法来比较新旧虚拟DOM，将结果渲染到真实DOM树上


# DOM的缺陷
我们在调用DOM的相关API比如appendChild的时候，会首先将节点加入到DOM中，然后去执行DOM的构建，CSSOM的构建，布局树的构建，分层等这一系列渲染所需要的操作，这样做，引起了重排，同时，也有可能引起重绘和合成。此外，还可能造成强制同步布局和布局抖动的问题

当然，虽然上面的缺陷会对渲染造成影响，但如果页面内容比较小，这个影响也不会太大，但是现在页面里的内容，越来越多，特别是很多网站的首页，非常复杂繁多，此时DOM的缺陷就会带来用户体验上的影响

为此，我们可以用上虚拟DOM

# 虚拟DOM
我们看看虚拟DOM要完成的事情
* 将页面改变的内容体现在虚拟DOM上，而不是直接体现在DOM上
* 页面改变的内容放到虚拟DOM上之后，虚拟DOM不立即渲染页面，而是先进行改变前后的比较，调整内部变化的那一部分
* 在累积到足够的变化或者足够的时间之后，将变化体现在真实DOM上

知道了虚拟DOM要完成的事情之后，我们从双缓存和MVC来谈谈虚拟DOM
## 双缓存
双缓存，就是通过使用两个缓冲区，我们将要计算的内容放在一个缓冲区，另一个缓冲区存储计算好的内容，计算的时间和使用的时间应该是一致的，所以在计算的缓冲区计算完毕的时候，另一个缓冲区的内容已经被使用完了，此时将两个缓冲区的功能置换，这样就可以不断续地使用计算好的内容

在这里，虽然没有一个置换的过程，但是可以将虚拟DOM看成是真实DOM的一个缓存，当虚拟DOM做好该做的计算之后，才将修改放到真实DOM上

## MVC
MVC实际上就是由模型（model），视图（view），控制器（control）组成。其核心思想就是分离数据和视图。数据与视图无法直接通信，需要通过控制器来通信，控制器根据信息判断是否需要更新视图。基于MVC又出现了很多其他的模型，比如MVP、MVVM，现在很多框架诸如Vue就是使用MVVM

但归根结底，这些模型还是基于MVC的，所以我们还是可以通过MVC来进行一个理解

我们可以把React的部分看成是一个MVC中的视图，在项目中结合Redux就可以构建一个MVC的模型结构

![](https://user-gold-cdn.xitu.io/2020/4/3/171409bb6115351d?w=1284&h=561&f=png&s=142535)

在该图中，我们可以把虚拟DOM看成是MVC的视图部分，其控制器和模型都是由Redux提供的。其具体实现过程如下：

* 图中的控制器是用来监控DOM的变化，一旦DOM发生变化，控制器便会通知模型，让其更新数据；
* 模型数据更新好之后，控制器会通知视图，告诉它模型的数据发生了变化；
* 视图接收到更新消息之后，会根据模型所提供的数据来生成新的虚拟DOM；
* 新的虚拟DOM生成好之后，就需要与之前的虚拟DOM进行比较，找出变化的节点；
* 比较出变化的节点之后，React将变化的虚拟节点应用到DOM上，这样就会触发DOM节点的更新；
* DOM节点的变化又会触发后续一系列渲染流水线的变化，从而实现页面的更新。



https://segmentfault.com/a/1190000016647776

# 虚拟DOM原理
1. 用JavaScript模拟DOM树
2. 比较新老DOM树，得到比较差异的对象
3. 把差异对象应用到渲染的DOM树